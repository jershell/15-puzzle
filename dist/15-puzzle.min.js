!function(){"use strict";function getRandomInt(e,n){return Math.floor(Math.random()*(n-e+1))+e}function thenIfCondition(array,condition,handler){for(var idx=0;idx<array.length;idx++)for(var jdx=0;jdx<array[idx].length;jdx++){var item=array[idx][jdx],value=item;eval(condition)&&handler(array[idx][jdx])}}function eachMatrix(e,n){for(var t=0;t<e.length;t++)for(var r=0;r<e[t].length;r++)n(e[t][r],t,r)}var FifteenPuzzle=function(e,n){function t(e){return!e.hasOwnProperty("element")||_.isUndefined(e.element)||_.isNull(e.element)}function r(){y=!0,_.isFunction(p.callBackAfterVictory)&&p.callBackAfterVictory()===!0&&(y=!1),y||(F=x(),k=F.matrix,w=F.elements)}function o(e){var n=1,r=0,o=0,i=[],a=function(e){return!(1&e)};for(var l in e)for(var f in e[l])t(e[l][f])?o=parseInt(l)+1:i.push(parseInt(e[l][f].element._objects[1].text)),n++;for(var u in i){for(var c=0,s=i.length,d=u;s>d;d++)i[u]>i[d]&&c++;r+=c}return r+=o,a(r)}function i(){var e;return eachMatrix(k,function(n){_.isObject(n.element)||(e=n)}),e}function a(){for(var e=[],n=(p.matrix,p.matrix,0);n<p.matrix;n++){e[n]=[];for(var t=0;t<p.matrix;t++)e[n][t]={x:t,y:n,left:t*g+b-1,top:n*C+b-1}}return e}function l(e){var n=new fabric.Rect({rx:5,ry:5,fill:p.puzzleColor,stroke:p.puzzleBorderColor,strokeWidth:p.puzzleBorderWidth,width:g-2*b,height:C-2*b,originX:"center",originY:"center"}),t=new fabric.Text(e,{fontSize:56,fill:p.puzzleBorderColor,fontWeight:"bold",originX:"center",originY:"center"}),r=new fabric.Group([n,t],{selectable:!1,width:2+(g-2*b),height:2+(C-2*b)});return r}function f(){return g+b-2}function u(e,n,t){var r=t+(""+f()),o=$.Deferred();return e.animate(n,r,{duration:100,onChange:h.canvas.renderAll.bind(h.canvas),onComplete:function(){var n=d(e.left,e.top);k[n.y][n.x].element=e,o.resolve(k[n.y][n.x])}}),o.promise()}function c(e,n){k[n][e].element=void 0}function s(e,n){var t=0;thenIfCondition(e,"item",function(e){if(t++,n.length>0){var r=getRandomInt(0,n.length-1),o=n[r];n.splice(r,1),_.isUndefined(o)?e.element=o:(o.setLeft(e.left),o.setTop(e.top),e.element=o,h.canvas.add(o))}})}function d(e,n){return{y:Math.round(n/(g+b)),x:Math.round(e/(C+b))}}function v(e){for(var n=1,t=p.matrix*p.matrix,r=!0,o=0;o<p.matrix;o++)for(var i=0;i<p.matrix;i++){var a=e[o][i];if(n===t)r=r&&_.isUndefined(a.element);else{if(!_.isObject(a.element)){r=!1;break}r=r&&a.element._objects[1].text===""+n}n++}return r}function m(e){var n;return thenIfCondition(k,"item",function(t){t.element&&e===t.element&&(n=t)}),n}function x(){h.canvas.clear();for(var e=a(),n=[],t=1;t<p.matrix*p.matrix;t++)n.push(l(""+t));return n.push(void 0),s(e,n),o(e)?(y=!1,{matrix:e,elements:n}):x()}var h=this,z={canvasSize:400,matrix:4,callBackAfterVictory:function(){return alert("you won!"),!1},fontColor:"#FFFFFF",puzzleColor:"#f55",backgroundColor:"#333",puzzleColorAfter:"#008000",border:!0,puzzleBorderColor:"#FFFFFF",puzzleBorderWidth:2},p=_.merge({},z,n),y=!0;h.selector=e,h.canvas=new fabric.Canvas(e),h.canvas.backgroundColor=p.backgroundColor,h.canvas.selection=!1,h.canvas.setWidth(p.canvasSize),h.canvas.setHeight(p.canvasSize);var g=p.canvasSize/p.matrix,C=g,b=2,F=x(),k=F.matrix,w=F.elements;h.setBackgroundColorOnPuzzle=function(e){for(var n=e||p.puzzleColorAfter,r=0;r<k.length;r++)for(var o=0;o<k[r].length;o++)t(k[r][o])||k[r][o].element._objects[0].set("fill",n);h.canvas.renderAll()},h.canvas.on("mouse:up",function(e){if(e.target&&!y){var n,t=i(),o=m(e.target),a=0,l=[],f={x:o.x-t.x,y:o.y-t.y};if(f.x===a){if(n=Math.abs(f.y),f.y<0){for(var s=o.y;s<t.y;s++)l.push(u(k[s][o.x].element,"top","+=")),c(o.x,s);$.when.apply($,l).done(function(){v(k)&&setTimeout(function(){h.setBackgroundColorOnPuzzle(),r()},100)})}if(f.y>a){for(var s=o.y;s>t.y;s--)l.push(u(k[s][o.x].element,"top","-=")),c(o.x,s);$.when.apply($,l).done(function(){v(k)&&setTimeout(function(){h.setBackgroundColorOnPuzzle(),r()},100)})}}if(f.y===a){if(n=Math.abs(f.x),f.x<0){for(var s=o.x;s<t.x;s++)l.push(u(k[o.y][s].element,"left","+=")),c(s,o.y);$.when.apply($,l).done(function(){v(k)&&setTimeout(function(){h.setBackgroundColorOnPuzzle(),r()},100)})}if(f.x>0){for(var s=o.x;s>t.x;s--)l.push(u(k[o.y][s].element,"left","-=")),c(s,o.y);$.when.apply($,l).done(function(){v(k)&&setTimeout(function(){h.setBackgroundColorOnPuzzle(),r()},100)})}}}})};window.FifteenPuzzle=FifteenPuzzle}();